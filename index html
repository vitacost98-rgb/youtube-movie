<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 影片研究員 - 進階自動化工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script>
        // --- [Google API 設定] ---
        const CLIENT_ID = '107140118174-mm7cbcacd1evj72plq2b9pm6f1gf9fk4.apps.googleusercontent.com'; 
        const API_KEY = ""; // 執行環境會自動提供，留空即可
        const SCOPES = [
            'https://www.googleapis.com/auth/drive', // 需要完整權限以執行刪除
            'https://www.googleapis.com/auth/documents'
        ].join(' ');
        // -------------------------

        const PROJECT_NUMBER = CLIENT_ID.split('-')[0];
        let tokenClient;
        let accessToken = null;
        let selectedVideos = []; // 存儲物件 {id, name}
        let targetDocId = null;

        // 初始化 Google API
        function gapiLoaded() {
            gapi.load('client:picker', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: [
                            'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                            'https://docs.googleapis.com/$discovery/rest?version=v1'
                        ]
                    });
                } catch (e) { console.error("GAPI Error:", e); }
            });
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    ux_mode: 'popup', 
                    callback: (resp) => {
                        if (resp.error) return showNotification("授權失敗", "error");
                        accessToken = resp.access_token;
                        document.getElementById('auth-status').innerHTML = `<span class="flex items-center text-emerald-400 font-bold text-xs"><i class="fas fa-check-circle mr-1"></i> 已連結 Google 帳號</span>`;
                        document.querySelectorAll('.auth-required').forEach(el => {
                            el.disabled = false;
                            el.classList.remove('opacity-50', 'cursor-not-allowed');
                        });
                    },
                });
            } catch (e) { console.error("GIS Error:", e); }
        }

        function handleAuthClick() {
            if (!tokenClient) return alert("API 載入中，請稍候...");
            tokenClient.requestAccessToken({ prompt: 'select_account' });
        }

        // --- 核心功能：選取與記憶 ---

        function createPicker(mimeType, callback, title) {
            // 記憶功能：從 LocalStorage 取得上次的資料夾 ID
            const lastFolderId = localStorage.getItem('last_folder_id');
            
            const view = new google.picker.DocsView(google.picker.ViewId.DOCS)
                .setMimeTypes(mimeType)
                .setIncludeFolders(true)
                .setSelectableMimeTypes(mimeType);

            // 如果有上次記錄的資料夾，則嘗試設定為起點 (Picker 會盡力定位)
            if (lastFolderId) {
                // 注意：Picker API 的 setParent 在某些檢視下限制較多，此為儘力嘗試
                // view.setParent(lastFolderId); 
            }
            
            const picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.NAV_HIDDEN)
                .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
                .setAppId(PROJECT_NUMBER)
                .setOAuthToken(accessToken)
                .addView(view)
                .setTitle(title)
                .setCallback((data) => {
                    if (data.action === google.picker.Action.PICKED) {
                        // 記憶本次選取的資料夾 (取第一個檔案的父目錄，Picker API 不直接提供父目錄，通常記錄第一個選取檔案的 ID 即可讓下次開啟更接近)
                        if (data.docs.length > 0) {
                            localStorage.setItem('last_folder_id', data.docs[0].parentId);
                        }
                        callback(data);
                    }
                })
                .build();
            picker.setVisible(true);
        }

        // 選取影片
        function selectVideos() {
            createPicker('video/mp4,video/quicktime,video/x-msvideo', videoPickerCallback, "選取影片檔案");
        }

        function videoPickerCallback(data) {
            selectedVideos = data.docs
                .filter(doc => doc.mimeType !== 'application/vnd.google-apps.folder')
                .map(doc => ({ id: doc.id, name: doc.name }));
            
            if (selectedVideos.length === 0) return showNotification("未選取有效影片", "warning");
            
            renderSelectedList();
            autoSuggestTargetDoc();
        }

        function renderSelectedList() {
            const container = document.getElementById('selected-files-list');
            container.innerHTML = selectedVideos.map(v => `
                <div class="bg-slate-800/50 p-2 rounded border border-slate-700 text-xs text-slate-300 flex justify-between items-center group">
                    <span><i class="fas fa-video mr-2 text-emerald-500"></i> ${v.name}</span>
                </div>
            `).join('');
            document.getElementById('raw-names-area').value = selectedVideos.map(v => v.name).join('\n');
            document.getElementById('step-2-result').classList.remove('hidden');
        }

        // --- 文件自動匹配與讀取 ---

        async function autoSuggestTargetDoc() {
            const statusEl = document.getElementById('match-status');
            statusEl.innerHTML = `<i class="fas fa-spinner animate-spin mr-2"></i> 正在檢索預設路徑文件...`;
            
            try {
                // 搜尋 YouTube_研究報告 資料夾
                const folderResp = await gapi.client.drive.files.list({
                    q: "name = 'YouTube_研究報告' and mimeType = 'application/vnd.google-apps.folder' and trashed = false",
                    fields: 'files(id, name)'
                });

                let folderId = folderResp.result.files.length > 0 ? folderResp.result.files[0].id : null;
                
                if (!folderId) {
                    statusEl.innerHTML = `
                        <div class="bg-amber-500/10 p-3 rounded-xl border border-amber-500/30 text-xs">
                            <p class="text-amber-400 mb-2">未發現「YouTube_研究報告」資料夾。</p>
                            <button onclick="manualSelectDoc()" class="bg-slate-700 px-3 py-1 rounded text-white">手動瀏覽雲端選取文件</button>
                        </div>
                    `;
                    return;
                }
                
                // 獲取資料夾內 Docs
                const docsResp = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and mimeType = 'application/vnd.google-apps.document' and trashed = false`,
                    fields: 'files(id, name)'
                });

                const docs = docsResp.result.files;
                let bestMatch = null;

                if (selectedVideos.length > 0) {
                    const firstVideo = selectedVideos[0].name.toLowerCase();
                    bestMatch = docs.find(d => firstVideo.includes(d.name.toLowerCase()) || d.name.toLowerCase().includes(firstVideo.split('.')[0]));
                }

                if (bestMatch) {
                    targetDocId = bestMatch.id;
                    statusEl.innerHTML = `
                        <div class="bg-emerald-500/10 p-3 rounded-xl border border-emerald-500/30">
                            <p class="text-emerald-400 font-bold mb-1 text-xs">智慧匹配：${bestMatch.name}</p>
                            <div class="flex gap-2">
                                <button onclick="confirmDoc(true)" class="bg-emerald-600 text-white px-3 py-1 rounded text-[10px]">確認</button>
                                <button onclick="manualSelectDoc()" class="bg-slate-700 text-slate-300 px-3 py-1 rounded text-[10px]">更改</button>
                            </div>
                        </div>
                    `;
                } else {
                    statusEl.innerHTML = `
                        <button onclick="manualSelectDoc()" class="w-full bg-slate-800 text-slate-300 py-2 rounded text-xs border border-slate-700">
                            無匹配，點此手動選取目標文件
                        </button>
                    `;
                }
            } catch (e) {
                statusEl.innerHTML = `<span class="text-red-400 text-xs">錯誤：${e.message}</span>`;
            }
        }

        function confirmDoc(isConfirmed) {
            if (isConfirmed) {
                showNotification("已設定目標文件", "success");
                document.getElementById('save-section').classList.remove('hidden');
            }
        }

        function manualSelectDoc() {
            createPicker('application/vnd.google-apps.document', (data) => {
                targetDocId = data.docs[0].id;
                document.getElementById('match-status').innerHTML = `
                    <div class="bg-emerald-500/10 p-3 rounded-xl border border-emerald-500/30 text-xs">
                        <p class="text-emerald-400">已選取：<b>${data.docs[0].name}</b></p>
                    </div>
                `;
                confirmDoc(true);
            }, "選取目標 Google 文件");
        }

        // --- 存檔與刪除邏輯 ---

        async function processAndSave() {
            const content = document.getElementById('ai-output-content').value;
            const deleteAfter = document.getElementById('delete-toggle').checked;
            
            if (!content) return alert("請貼入 AI 報告內容");
            if (!targetDocId) return alert("請先選取目標文件");

            if (deleteAfter) {
                const confirmed = confirm(`警告：存檔成功後將會把選取的 ${selectedVideos.length} 個影片檔案移至垃圾桶。確定嗎？`);
                if (!confirmed) return;
            }

            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner animate-spin mr-2"></i> 正在存檔中...`;

            try {
                // 1. 寫入文件
                await gapi.client.docs.documents.batchUpdate({
                    documentId: targetDocId,
                    resource: {
                        requests: [{
                            insertText: {
                                endOfSegmentLocation: { segmentId: "" },
                                text: `\n\n--- AI 研究報告 (${new Date().toLocaleString()}) ---\n${content}`
                            }
                        }]
                    }
                });

                // 2. 刪除影片 (如果勾選)
                if (deleteAfter) {
                    for (const video of selectedVideos) {
                        await gapi.client.drive.files.update({
                            fileId: video.id,
                            resource: { trashed: true }
                        });
                    }
                    showNotification(`存檔成功，且 ${selectedVideos.length} 個檔案已移至垃圾桶`, "success");
                } else {
                    showNotification("內容已成功追加至 Google 文件！", "success");
                }
                
                document.getElementById('ai-output-content').value = "";
            } catch (e) {
                console.error(e);
                alert("執行失敗：" + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `確認存檔並執行後續動作`;
            }
        }

        // 剪貼簿功能
        function copyNames() {
            const textarea = document.getElementById("raw-names-area");
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) showNotification("清單已複製，請貼給 AI 分析", "success");
            } catch (err) {
                alert("複製失敗，請手動全選複製。");
            }
        }

        function showNotification(msg, type) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-2xl shadow-2xl text-white text-sm font-bold z-50 transform transition-all duration-300 translate-y-0 ${type === 'success' ? 'bg-emerald-600' : 'bg-amber-600'}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-2"></i> ${msg}`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0b0f1a; }
        .glass-card { background: rgba(22, 30, 46, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .accent-gradient { background: linear-gradient(135deg, #60a5fa 0%, #34d399 100%); }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen text-slate-200">

    <div class="max-w-5xl mx-auto space-y-6">
        <!-- 頂部列 -->
        <header class="flex flex-col md:flex-row justify-between items-center glass-card p-6 rounded-3xl gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-2xl font-bold accent-gradient bg-clip-text text-transparent">YouTube 研究員 Pro</h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1">智慧匹配路徑 • 自動存檔 • 雲端清理</p>
            </div>
            <div id="auth-status">
                <button onclick="handleAuthClick()" class="bg-blue-600 hover:bg-blue-500 px-5 py-2.5 rounded-2xl text-xs font-bold transition flex items-center gap-2">
                    <i class="fab fa-google"></i> 連結 Google 帳號
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
            <!-- 左側操作區 -->
            <div class="md:col-span-5 space-y-6">
                <!-- 第一步：選取影片 -->
                <section class="glass-card p-6 rounded-3xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-bold flex items-center gap-2 text-emerald-400">
                            <span class="w-6 h-6 bg-emerald-500/20 rounded-full flex items-center justify-center text-[10px]">1</span> 影片選取
                        </h2>
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <span class="text-[10px] text-slate-400 group-hover:text-red-400 transition">存檔後刪除影片</span>
                            <div class="relative inline-block w-8 h-4">
                                <input type="checkbox" id="delete-toggle" class="peer hidden">
                                <div class="w-full h-full bg-slate-700 rounded-full peer-checked:bg-red-500 transition-colors"></div>
                                <div class="absolute left-1 top-1 w-2 h-2 bg-white rounded-full transition-transform peer-checked:translate-x-4"></div>
                            </div>
                        </label>
                    </div>

                    <button onclick="selectVideos()" disabled class="auth-required opacity-50 cursor-not-allowed w-full bg-slate-800 hover:bg-slate-700 py-4 rounded-2xl border border-slate-700 transition text-sm mb-4">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> 瀏覽雲端資料夾選取影片
                    </button>
                    
                    <div id="step-2-result" class="hidden space-y-4">
                        <div id="selected-files-list" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar"></div>
                        <textarea id="raw-names-area" class="sr-only"></textarea>
                        <button onclick="copyNames()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl text-xs font-bold transition shadow-lg shadow-indigo-900/40">
                            <i class="far fa-copy mr-2"></i> 確認並複製影片清單給 AI
                        </button>
                    </div>
                </section>

                <!-- 第二步：路徑狀態 -->
                <section class="glass-card p-6 rounded-3xl">
                    <h2 class="text-sm font-bold mb-4 flex items-center gap-2 text-cyan-400">
                        <span class="w-6 h-6 bg-cyan-500/20 rounded-full flex items-center justify-center text-[10px]">2</span> 目標 Google 文件
                    </h2>
                    <div id="match-status" class="text-xs text-slate-500 italic bg-slate-900/50 p-4 rounded-2xl border border-dashed border-slate-700">
                        等待影片選取中...
                    </div>
                </section>
            </div>

            <!-- 右側輸入區 -->
            <div class="md:col-span-7">
                <div id="save-section" class="hidden h-full">
                    <section class="glass-card p-6 rounded-3xl border-emerald-500/20 flex flex-col h-full">
                        <h2 class="text-sm font-bold mb-4 flex items-center gap-2 text-emerald-400">
                            <span class="w-6 h-6 bg-emerald-500/20 rounded-full flex items-center justify-center text-[10px]">3</span> 產出分析報告
                        </h2>
                        <p class="text-[10px] text-slate-500 mb-3 uppercase tracking-wider">貼入 AI 產出的 Markdown 格式內容：</p>
                        <textarea id="ai-output-content" class="flex-grow w-full bg-slate-900/80 border border-slate-700 rounded-2xl p-4 text-sm focus:ring-1 focus:ring-emerald-500 outline-none mb-4 min-h-[400px]" placeholder="# 分析報告標題..."></textarea>
                        
                        <button id="save-btn" onclick="processAndSave()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-2xl font-bold transition-all transform hover:scale-[1.01] shadow-xl shadow-emerald-900/30">
                            確認存檔並執行後續動作
                        </button>
                        <p class="text-center text-[10px] text-slate-500 mt-3 italic">存檔後，系統將自動定位至文件末尾追加內容</p>
                    </section>
                </div>

                <!-- 初始提示 -->
                <div id="save-placeholder" class="h-full glass-card rounded-3xl flex items-center justify-center p-12 text-center opacity-40">
                    <div>
                        <i class="fas fa-file-signature text-4xl mb-4 text-slate-600"></i>
                        <p class="text-sm">完成前兩個步驟後，此處將開啟存檔區域</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-8 text-center text-slate-600 text-[10px] uppercase tracking-widest pb-8">
        Memory Enabled • Auto-Cleanup • Smart Path Sync
    </footer>

    <script>
        // 切換右側顯示
        const observer = new MutationObserver(() => {
            const saveSec = document.getElementById('save-section');
            const placeholder = document.getElementById('save-placeholder');
            if (!saveSec.classList.contains('hidden')) {
                placeholder.classList.add('hidden');
            }
        });
        observer.observe(document.getElementById('save-section'), { attributes: true });
    </script>
</body>
</html>