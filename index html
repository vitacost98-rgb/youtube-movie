<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 研究員 Pro - 雲端自動化版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script>
        // --- [重要設定區] ---
        // 1. 請確保您的 OAuth 用戶端 ID 已允許 https://vitacost98-rgb.github.io
        const CLIENT_ID = '107140118174-mm7cbcacd1evj72plq2b9pm6f1gf9fk4.apps.googleusercontent.com'; 
        
        // 2. 在 GitHub Pages 部署時，此處必須填入有效的 API KEY 否則選取器無法開啟
        const API_KEY = ""; 
        
        const SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/documents';
        const DEFAULT_FOLDER_NAME = "YouTube_研究報告"; 
        // ------------------

        const PROJECT_NUMBER = CLIENT_ID.split('-')[0];
        let tokenClient;
        let accessToken = null;
        let selectedVideos = []; 
        let targetDoc = { id: null, name: "" };
        let projectFolderId = null;

        // 初始化 Google API
        function gapiLoaded() {
            gapi.load('client:picker', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: [
                            'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                            'https://docs.googleapis.com/$discovery/rest?version=v1'
                        ]
                    });
                } catch (e) { console.error("GAPI Error:", e); }
            });
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    ux_mode: 'popup', 
                    callback: (resp) => {
                        if (resp.error) return alert("授權失敗：" + resp.error);
                        accessToken = resp.access_token;
                        document.getElementById('auth-btn').innerHTML = `<i class="fas fa-check-circle"></i> 雲端硬碟已連線`;
                        document.getElementById('auth-btn').className = "bg-emerald-600 px-6 py-2.5 rounded-2xl text-sm font-bold flex items-center gap-2 transition shadow-lg shadow-emerald-900/20";
                        initializeEnvironment();
                    },
                });
            } catch (e) { console.error("GIS Error:", e); }
        }

        function handleAuthClick() {
            if (!tokenClient) return alert("API 初始化中，請稍候...");
            tokenClient.requestAccessToken({ prompt: 'select_account' });
        }

        // 確認/建立預設研究資料夾
        async function initializeEnvironment() {
            showLoading(true, "正在檢查雲端研究資料夾...");
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name = '${DEFAULT_FOLDER_NAME}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`,
                    fields: 'files(id, name)'
                });
                const folders = response.result.files;
                if (folders && folders.length > 0) {
                    projectFolderId = folders[0].id;
                    console.log("發現既有資料夾:", projectFolderId);
                } else {
                    const folder = await gapi.client.drive.files.create({
                        resource: { name: DEFAULT_FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' },
                        fields: 'id'
                    });
                    projectFolderId = folder.result.id;
                    console.log("建立新資料夾:", projectFolderId);
                }
                // 啟動按鈕
                document.querySelectorAll('.auth-required').forEach(el => {
                    el.disabled = false;
                    el.classList.remove('opacity-50', 'cursor-not-allowed');
                });
            } catch (err) { 
                console.error("Initialize Error:", err);
                alert("初始化失敗，請確認 API Key 與 OAuth 權限。");
            } finally { showLoading(false); }
        }

        // --- Picker 核心：支援瀏覽與記憶 ---
        function openUniversalPicker(mimeType, callback, title) {
            if (!accessToken) return handleAuthClick();
            
            // 讀取記憶的資料夾 ID
            const lastFolderId = localStorage.getItem('yt_last_folder_id');
            
            // 建立文件視圖
            const docsView = new google.picker.DocsView(google.picker.ViewId.DOCS)
                .setMimeTypes(mimeType)
                .setIncludeFolders(true) // 允許看到資料夾
                .setSelectableMimeTypes(mimeType); // 僅允許選取目標格式檔案

            const pickerBuilder = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.NAV_HIDDEN) // 顯示左側導覽列以便跳轉
                .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
                .setAppId(PROJECT_NUMBER)
                .setOAuthToken(accessToken)
                .addView(docsView)
                .setTitle(title)
                .setCallback((data) => {
                    if (data.action === google.picker.Action.PICKED) {
                        // 記憶本次操作所在的父資料夾
                        if (data.docs.length > 0 && data.docs[0].parentId) {
                            localStorage.setItem('yt_last_folder_id', data.docs[0].parentId);
                        }
                        callback(data);
                    }
                });

            const picker = pickerBuilder.build();
            picker.setVisible(true);
        }

        // 選取影片
        function selectVideos() {
            openUniversalPicker('video/mp4,video/quicktime,video/x-msvideo', (data) => {
                selectedVideos = data.docs.map(doc => ({ id: doc.id, name: doc.name }));
                renderVideoList();
                autoMatchDocument();
            }, "選取要研究的影片檔案");
        }

        function renderVideoList() {
            const listDiv = document.getElementById('selected-list');
            listDiv.innerHTML = selectedVideos.map(v => `
                <div class="flex justify-between items-center bg-slate-900/60 p-3 rounded-xl border border-slate-800 text-[11px] animate-fade-in group">
                    <span class="truncate pr-2 flex items-center gap-2">
                        <i class="fas fa-video text-emerald-500"></i>
                        ${v.name}
                    </span>
                    <i class="fas fa-check text-emerald-400 opacity-0 group-hover:opacity-100 transition"></i>
                </div>
            `).join('');
            document.getElementById('raw-names-hidden').value = selectedVideos.map(v => v.name).join('\n');
            document.getElementById('action-panel').classList.remove('hidden');
        }

        // 智慧匹配：在預設資料夾中搜尋
        async function autoMatchDocument() {
            if (!projectFolderId || selectedVideos.length === 0) return;
            const statusEl = document.getElementById('match-status');
            statusEl.innerHTML = `<div class="flex items-center gap-2 text-slate-400"><i class="fas fa-spinner animate-spin"></i> 搜尋對應報告中...</div>`;

            try {
                const response = await gapi.client.drive.files.list({
                    q: `'${projectFolderId}' in parents and mimeType = 'application/vnd.google-apps.document' and trashed = false`,
                    fields: 'files(id, name)'
                });
                const files = response.result.files;
                
                // 拿第一個影片名稱來匹配 (去掉副檔名)
                const searchBase = selectedVideos[0].name.toLowerCase().split('.')[0];
                const match = files.find(f => searchBase.includes(f.name.toLowerCase()) || f.name.toLowerCase().includes(searchBase));

                if (match) {
                    targetDoc = { id: match.id, name: match.name };
                    statusEl.innerHTML = `
                        <div class="bg-emerald-500/10 border border-emerald-500/30 p-4 rounded-2xl">
                            <p class="text-[10px] text-emerald-400 font-bold mb-1 uppercase">智慧匹配成功</p>
                            <p class="text-xs text-white truncate font-semibold">${match.name}</p>
                            <div class="mt-3 flex gap-2">
                                <button onclick="confirmTarget(true)" class="bg-emerald-600 hover:bg-emerald-500 text-[10px] px-4 py-1.5 rounded-lg transition">確認使用此文件</button>
                                <button onclick="manualSelectDoc()" class="bg-slate-700 hover:bg-slate-600 text-[10px] px-4 py-1.5 rounded-lg text-slate-300 transition">手動更改</button>
                            </div>
                        </div>
                    `;
                } else {
                    statusEl.innerHTML = `
                        <button onclick="manualSelectDoc()" class="w-full bg-slate-800 border-2 border-dashed border-slate-700 p-4 rounded-2xl text-xs text-slate-400 hover:border-emerald-500 hover:text-white transition group">
                            <i class="fas fa-plus-circle mr-2 group-hover:scale-110 transition inline-block"></i> 未找到匹配，點此手動選取或建立
                        </button>
                    `;
                }
            } catch (err) { console.error(err); statusEl.innerText = "匹配出錯，請手動選取。"; }
        }

        function manualSelectDoc() {
            openUniversalPicker('application/vnd.google-apps.document', (data) => {
                targetDoc = { id: data.docs[0].id, name: data.docs[0].name };
                confirmTarget(true);
            }, "選取目標 Google 研究報告文件");
        }

        function confirmTarget(isOk) {
            if(isOk) {
                document.getElementById('match-status').innerHTML = `
                    <div class="p-4 bg-emerald-500/20 rounded-2xl border border-emerald-500/50 text-xs text-emerald-400 flex items-center gap-3">
                        <i class="fas fa-lock"></i>
                        <div>
                            <p class="font-bold">目標已鎖定</p>
                            <p class="text-white opacity-80">${targetDoc.name}</p>
                        </div>
                    </div>`;
                document.getElementById('save-area').classList.remove('hidden');
                document.getElementById('save-area').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // 複製與存檔
        function copyVideoNames() {
            const copyArea = document.getElementById('raw-names-hidden');
            copyArea.classList.remove('sr-only');
            copyArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) showToast("影片清單已複製！請貼給 AI 分析。");
            } catch (e) {
                alert("複製失敗，請手動複製。");
            }
            copyArea.classList.add('sr-only');
        }

        async function executeSave() {
            const content = document.getElementById('ai-output').value;
            const deleteEnabled = document.getElementById('delete-toggle').checked;
            
            if (!content) return alert("請貼入 AI 分析產出的內容");

            if (deleteEnabled) {
                const check = confirm(`【安全確認】存檔成功後，系統將會自動將以下 ${selectedVideos.length} 個原始影片移至「雲端垃圾桶」。確定要執行嗎？`);
                if (!check) return;
            }

            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner animate-spin mr-2"></i> 同步中...`;

            try {
                // 1. 寫入文件末尾
                await gapi.client.docs.documents.batchUpdate({
                    documentId: targetDoc.id,
                    resource: {
                        requests: [{
                            insertText: {
                                endOfSegmentLocation: { segmentId: "" },
                                text: `\n\n--- AI 研究紀錄 (${new Date().toLocaleString()}) ---\n${content}`
                            }
                        }]
                    }
                });

                // 2. 刪除原始檔案
                if (deleteEnabled) {
                    for (const v of selectedVideos) {
                        await gapi.client.drive.files.update({
                            fileId: v.id,
                            resource: { trashed: true }
                        });
                    }
                    alert("存檔成功！原始影片已移至垃圾桶。");
                } else {
                    alert("存檔成功！內容已追加至文件。");
                }
                
                document.getElementById('ai-output').value = "";
                // 這裡可以選擇是否重置 selectedVideos
            } catch (err) {
                console.error(err);
                alert("執行失敗：" + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-cloud-upload-alt mr-2"></i> 確認存檔並完成流程`;
            }
        }

        // 通用 UI 組件
        function showLoading(show, text = "") {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
            document.getElementById('loading-text').textContent = text;
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = "fixed bottom-10 left-1/2 -translate-x-1/2 bg-indigo-600 text-white px-8 py-3 rounded-full shadow-2xl font-bold z-50 animate-bounce";
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0b0f1a; color: #f8fafc; }
        .glass-card { background: rgba(22, 27, 34, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1.5rem; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-10 min-h-screen">

    <div class="max-w-6xl mx-auto space-y-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-6 glass-card p-8 border-b border-emerald-500/20">
            <div class="space-y-1">
                <h1 class="text-3xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-cyan-400">YouTube Researcher Pro</h1>
                <p class="text-slate-500 text-[11px] uppercase tracking-[0.3em] font-medium">智慧路徑記憶 • 自動化存檔與清理</p>
            </div>
            <button id="auth-btn" onclick="handleAuthClick()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2.5 rounded-2xl text-sm font-bold flex items-center gap-2 transition shadow-lg shadow-blue-900/30">
                <i class="fab fa-google"></i> 連結雲端帳號
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left Panel -->
            <div class="lg:col-span-4 space-y-8">
                <!-- Step 1 -->
                <section class="glass-card p-6 shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold flex items-center gap-2 text-emerald-400">
                            <span class="w-7 h-7 bg-emerald-500/20 rounded-full flex items-center justify-center text-xs">1</span> 影片選取
                        </h2>
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <span class="text-[10px] text-slate-500 group-hover:text-red-400 transition font-bold">自動刪除影片</span>
                            <div class="relative inline-block w-8 h-4">
                                <input type="checkbox" id="delete-toggle" class="peer hidden">
                                <div class="w-full h-full bg-slate-800 rounded-full peer-checked:bg-red-500/80 transition-colors border border-slate-700"></div>
                                <div class="absolute left-1 top-1 w-2 h-2 bg-white rounded-full transition-transform peer-checked:translate-x-4"></div>
                            </div>
                        </label>
                    </div>

                    <button onclick="selectVideos()" disabled class="auth-required opacity-50 cursor-not-allowed w-full bg-slate-800 hover:bg-slate-700 py-5 rounded-2xl border border-slate-700 transition text-sm font-bold flex flex-col items-center gap-2">
                        <i class="fas fa-folder-open text-xl text-emerald-500"></i>
                        <span>瀏覽並選取影片檔案</span>
                    </button>

                    <div id="action-panel" class="mt-6 hidden space-y-4 animate-fade-in">
                        <div id="selected-list" class="space-y-2 max-h-56 overflow-y-auto pr-1"></div>
                        <textarea id="raw-names-hidden" class="sr-only"></textarea>
                        <button onclick="copyVideoNames()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-xl text-xs font-bold transition shadow-lg shadow-indigo-900/40 transform hover:-translate-y-1">
                            <i class="far fa-copy mr-2"></i> 確認並複製清單供 AI 研究
                        </button>
                    </div>
                </section>

                <!-- Step 2 -->
                <section class="glass-card p-6 shadow-xl">
                    <h2 class="text-lg font-bold mb-5 flex items-center gap-2 text-cyan-400">
                        <span class="w-7 h-7 bg-cyan-500/20 rounded-full flex items-center justify-center text-xs">2</span> 目標研究報告
                    </h2>
                    <div id="match-status" class="text-xs text-slate-500 italic bg-slate-900/40 p-5 rounded-2xl border border-dashed border-slate-700 min-h-[80px] flex items-center justify-center text-center">
                        等待選取影片中...
                    </div>
                </section>
            </div>

            <!-- Right Panel -->
            <div class="lg:col-span-8">
                <div id="save-area" class="hidden h-full">
                    <section class="glass-card p-8 flex flex-col h-full border border-emerald-500/10 shadow-2xl">
                        <h2 class="text-xl font-bold mb-6 flex items-center gap-3 text-emerald-400">
                            <i class="fas fa-microchip text-2xl"></i> AI 研究報告存檔
                        </h2>
                        
                        <div class="flex-grow flex flex-col space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">報告內容 (Markdown)：</label>
                                <span class="text-[10px] text-slate-600 italic">存檔後內容將追加至文件末尾</span>
                            </div>
                            <textarea id="ai-output" class="flex-grow w-full bg-slate-900/80 border border-slate-700 rounded-2xl p-6 text-sm focus:ring-2 focus:ring-emerald-500/50 outline-none transition custom-scrollbar min-h-[450px]" placeholder="# 分析摘要...&#10;## 逐字稿重點..."></textarea>
                            
                            <button id="save-btn" onclick="executeSave()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-5 rounded-2xl font-extrabold text-base transition-all transform hover:scale-[1.02] shadow-2xl shadow-emerald-900/40 flex items-center justify-center group">
                                <i class="fas fa-save mr-3 group-hover:rotate-12 transition"></i> 確認存檔並完成流程
                            </button>
                        </div>
                    </section>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="h-full glass-card flex flex-col items-center justify-center p-16 text-center opacity-30 border-2 border-dashed border-slate-800">
                    <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-6">
                        <i class="fas fa-terminal text-3xl text-slate-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-400 italic">系統待命中心</h3>
                    <p class="text-sm text-slate-600 mt-3 max-w-xs">請先完成左側的影片選取與文件匹配，存檔區域將會自動解鎖。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-950/90 backdrop-blur-md z-[100] hidden flex flex-col items-center justify-center">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-emerald-500/20 rounded-full"></div>
            <div class="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin absolute top-0 left-0"></div>
        </div>
        <p id="loading-text" class="mt-8 text-emerald-400 text-sm font-bold tracking-[0.3em] uppercase animate-pulse"></p>
    </div>

    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
    <script>
        // 切換右側顯示邏輯
        const observer = new MutationObserver(() => {
            const area = document.getElementById('save-area');
            const state = document.getElementById('empty-state');
            if (!area.classList.contains('hidden')) {
                state.classList.add('hidden');
            }
        });
        observer.observe(document.getElementById('save-area'), { attributes: true });
    </script>
</body>
</html>
