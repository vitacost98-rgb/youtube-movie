<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 影片研究員 - 檔案選取與自動儲存工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script>
        // --- [Google API 設定] ---
        const CLIENT_ID = '107140118174-mm7cbcacd1evj72plq2b9pm6f1gf9fk4.apps.googleusercontent.com'; 
        const API_KEY = ""; 
        const SCOPES = [
            'https://www.googleapis.com/auth/drive.readonly',
            'https://www.googleapis.com/auth/drive.metadata.readonly',
            'https://www.googleapis.com/auth/documents',
            'https://www.googleapis.com/auth/drive.file' 
        ].join(' ');
        // -------------------------

        const PROJECT_NUMBER = CLIENT_ID.split('-')[0];
        let tokenClient;
        let accessToken = null;
        let selectedVideoNames = [];
        let targetDocId = null;
        let targetDocName = "";
        let currentSelectedFolderId = 'root';

        // 初始化 Google API
        function gapiLoaded() {
            gapi.load('client:picker', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: [
                            'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                            'https://docs.googleapis.com/$discovery/rest?version=v1'
                        ]
                    });
                } catch (e) { console.error("GAPI 載入失敗:", e); }
            });
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    ux_mode: 'popup', 
                    callback: (resp) => {
                        if (resp.error) return alert("授權失敗");
                        accessToken = resp.access_token;
                        document.getElementById('auth-status').innerHTML = `<span class="flex items-center text-emerald-400 font-bold text-xs"><i class="fas fa-check-circle mr-1"></i> 雲端已連線</span>`;
                        document.querySelectorAll('.auth-required').forEach(el => {
                            el.disabled = false;
                            el.classList.remove('opacity-50');
                        });
                    },
                });
            } catch (e) { console.error("GIS 載入失敗:", e); }
        }

        function handleAuthClick() {
            if (!tokenClient) return alert("系統初始化中，請稍候...");
            tokenClient.requestAccessToken({ prompt: 'select_account' });
        }

        // --- 影片選取功能 ---

        function createVideoPicker() {
            const view = new google.picker.DocsView(google.picker.ViewId.DOCS)
                .setMimeTypes('video/mp4,video/quicktime,video/x-msvideo,application/vnd.google-apps.document,text/plain')
                .setIncludeFolders(true);
            
            const picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
                .setAppId(PROJECT_NUMBER)
                .setOAuthToken(accessToken)
                .addView(view)
                .setCallback(videoPickerCallback)
                .build();
            picker.setVisible(true);
        }

        function videoPickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                const newFiles = data.docs
                    .filter(doc => doc.mimeType !== 'application/vnd.google-apps.folder')
                    .map(doc => doc.name);
                
                // 採累加方式，並過濾重複
                selectedVideoNames = [...new Set([...selectedVideoNames, ...newFiles])];
                renderSelectedList();
            }
        }

        function removeVideo(index) {
            selectedVideoNames.splice(index, 1);
            renderSelectedList();
        }

        function renderSelectedList() {
            const container = document.getElementById('selected-files-list');
            const step2Result = document.getElementById('step-1-result-area');
            
            if (selectedVideoNames.length === 0) {
                container.innerHTML = `<p class="text-[10px] text-slate-500 italic">尚未選取影片</p>`;
                step2Result.classList.add('hidden');
                return;
            }

            step2Result.classList.remove('hidden');
            container.innerHTML = selectedVideoNames.map((name, idx) => `
                <div class="bg-slate-800/60 p-2 rounded-lg border border-slate-700 text-xs text-slate-300 flex justify-between items-center group">
                    <span class="truncate pr-2"><i class="fas fa-video mr-2 text-emerald-500/70"></i>${name}</span>
                    <button onclick="removeVideo(${idx})" class="text-slate-500 hover:text-red-400 transition-colors">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
            `).join('');
            document.getElementById('raw-names').value = selectedVideoNames.join('\n');
        }

        // --- 目標位置選取與建立功能 ---

        function manualSelectTarget() {
            // 允許選取文件與資料夾
            const view = new google.picker.DocsView(google.picker.ViewId.DOCS)
                .setMimeTypes('application/vnd.google-apps.document,application/vnd.google-apps.folder')
                .setIncludeFolders(true)
                .setSelectableMimeTypes('application/vnd.google-apps.document,application/vnd.google-apps.folder');
            
            const picker = new google.picker.PickerBuilder()
                .setAppId(PROJECT_NUMBER)
                .setOAuthToken(accessToken)
                .addView(view)
                .setCallback(handleTargetSelection)
                .build();
            picker.setVisible(true);
        }

        async function handleTargetSelection(data) {
            if (data.action === google.picker.Action.PICKED) {
                const item = data.docs[0];
                const statusEl = document.getElementById('target-status-content');
                
                if (item.mimeType === 'application/vnd.google-apps.folder') {
                    // 選取的是資料夾
                    currentSelectedFolderId = item.id;
                    targetDocId = null; // 清空先前選取的文件
                    
                    statusEl.innerHTML = `
                        <div class="bg-blue-500/10 p-4 rounded-xl border border-blue-500/30">
                            <p class="text-blue-400 text-xs mb-3 font-bold"><i class="fas fa-folder-open mr-2"></i>已選取資料夾：${item.name}</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="triggerCreateDoc()" class="bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded text-[10px] font-bold transition">
                                    <i class="fas fa-plus-circle mr-1"></i> 新增文件
                                </button>
                                <button onclick="triggerCreateFolder()" class="bg-slate-700 hover:bg-slate-600 text-slate-200 py-2 rounded text-[10px] font-bold transition">
                                    <i class="fas fa-folder-plus mr-1"></i> 新增資料夾
                                </button>
                            </div>
                        </div>
                    `;
                    document.getElementById('save-section').classList.add('hidden');
                } else {
                    // 選取的是文件
                    targetDocId = item.id;
                    targetDocName = item.name;
                    statusEl.innerHTML = `
                        <div class="bg-emerald-500/10 p-4 rounded-xl border border-emerald-500/30">
                            <p class="text-emerald-400 text-xs font-bold"><i class="fas fa-file-alt mr-2"></i>目標文件：${item.name}</p>
                            <button onclick="manualSelectTarget()" class="mt-2 text-[9px] text-slate-500 hover:text-slate-300 underline">更換位置</button>
                        </div>
                    `;
                    document.getElementById('save-section').classList.remove('hidden');
                }
            }
        }

        async function triggerCreateDoc() {
            const name = prompt("請輸入新 Google 文件的名稱：", selectedVideoNames[0] ? selectedVideoNames[0] + "_研究報告" : "新 YouTube 研究報告");
            if (!name) return;
            
            try {
                const resp = await gapi.client.drive.files.create({
                    resource: {
                        name: name,
                        mimeType: 'application/vnd.google-apps.document',
                        parents: [currentSelectedFolderId]
                    },
                    fields: 'id, name'
                });
                targetDocId = resp.result.id;
                targetDocName = resp.result.name;
                
                document.getElementById('target-status-content').innerHTML = `
                    <div class="bg-emerald-500/10 p-4 rounded-xl border border-emerald-500/30">
                        <p class="text-emerald-400 text-xs font-bold"><i class="fas fa-check-circle mr-2"></i>已建立並設定目標：<br>${targetDocName}</p>
                        <button onclick="manualSelectTarget()" class="mt-2 text-[9px] text-slate-500 hover:text-slate-300 underline">選取其他位置</button>
                    </div>
                `;
                document.getElementById('save-section').classList.remove('hidden');
            } catch (e) { alert("文件建立失敗：" + e.message); }
        }

        async function triggerCreateFolder() {
            const name = prompt("請輸入新資料夾名稱：");
            if (!name) return;
            try {
                const resp = await gapi.client.drive.files.create({
                    resource: {
                        name: name,
                        mimeType: 'application/vnd.google-apps.folder',
                        parents: [currentSelectedFolderId]
                    },
                    fields: 'id, name'
                });
                currentSelectedFolderId = resp.result.id;
                // 更新狀態為新建立的資料夾
                handleTargetSelection({ action: 'picked', docs: [{ id: resp.result.id, name: resp.result.name, mimeType: 'application/vnd.google-apps.folder' }] });
                alert(`資料夾「${name}」建立成功。`);
            } catch (e) { alert("資料夾建立失敗：" + e.message); }
        }

        // --- 寫入內容功能 ---

        async function saveToGoogleDoc() {
            const content = document.getElementById('ai-output-content').value;
            if (!content) return alert("請貼入 AI 產出的內容！");
            if (!targetDocId) return alert("請先選取或建立一個目標文件！");

            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner animate-spin mr-2"></i> 正在寫入雲端...`;

            try {
                await gapi.client.docs.documents.batchUpdate({
                    documentId: targetDocId,
                    resource: {
                        requests: [{
                            insertText: {
                                endOfSegmentLocation: { segmentId: "" },
                                text: "\n\n--- AI 深度研究報告 (" + new Date().toLocaleString() + ") ---\n" + content
                            }
                        }]
                    }
                });
                alert("內容已成功追加至 Google 文件末尾！");
                document.getElementById('ai-output-content').value = ""; // 清空輸入框
            } catch (e) { alert("存檔失敗：" + e.message); } finally {
                btn.disabled = false;
                btn.innerText = "確認存檔 (追加至文件末尾)";
            }
        }

        function copyNames() {
            const copyText = document.getElementById("raw-names");
            copyText.classList.remove('hidden');
            copyText.focus(); 
            copyText.select();
            try {
                if (document.execCommand('copy')) {
                    alert("影片名稱清單已複製！");
                }
            } catch (err) { alert("複製失敗，請手動複製。"); }
            copyText.classList.add('hidden');
        }
    </script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0b0f1a; scroll-behavior: smooth; }
        .glass-card { background: rgba(22, 30, 46, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .accent-gradient { background: linear-gradient(135deg, #6366f1 0%, #10b981 100%); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen text-slate-200">

    <div class="max-w-5xl mx-auto space-y-6">
        <!-- 頁首 -->
        <header class="flex flex-col md:flex-row justify-between items-center glass-card p-6 rounded-3xl gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-2xl font-black accent-gradient bg-clip-text text-transparent">YouTube 深度研究員</h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1">獨立選取位置 • 智慧文件管理 • AI 成果自動同步</p>
            </div>
            <div id="auth-status">
                <button onclick="handleAuthClick()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-2 rounded-xl text-xs font-bold transition-all shadow-lg shadow-indigo-900/20">
                    <i class="fab fa-google mr-2"></i>連結 Google 帳號
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左側：影片管理區 -->
            <div class="space-y-6">
                <section class="glass-card p-6 rounded-3xl h-full">
                    <h2 class="text-sm font-bold mb-4 flex items-center gap-2 text-indigo-400">
                        <i class="fas fa-film"></i> 1. 影片檔案管理
                    </h2>
                    <button onclick="createVideoPicker()" disabled class="auth-required opacity-50 w-full bg-slate-800 hover:bg-slate-700 py-3 rounded-xl border border-slate-700 transition text-xs font-bold mb-4">
                        <i class="fas fa-plus mr-2"></i>選取/增加影片
                    </button>
                    
                    <div id="selected-files-list" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar mb-4">
                        <p class="text-[10px] text-slate-500 italic">尚未選取影片</p>
                    </div>

                    <div id="step-1-result-area" class="hidden pt-4 border-t border-slate-700/50">
                        <textarea id="raw-names" class="hidden"></textarea>
                        <button onclick="copyNames()" class="w-full bg-indigo-600/20 hover:bg-indigo-600/40 text-indigo-300 py-2 rounded-lg text-[10px] font-bold border border-indigo-500/30 transition">
                            <i class="far fa-copy mr-1"></i> 複製清單提供給 AI
                        </button>
                    </div>
                </section>
            </div>

            <!-- 中間：儲存位置區 -->
            <div class="space-y-6">
                <section class="glass-card p-6 rounded-3xl h-full">
                    <h2 class="text-sm font-bold mb-4 flex items-center gap-2 text-cyan-400">
                        <i class="fas fa-hdd"></i> 2. 設定儲存位置
                    </h2>
                    <p class="text-[10px] text-slate-400 mb-4 leading-relaxed">您可以直接選取現有文件，或是選取資料夾後點擊「新增」來建立。此操作與影片選取互不干擾。</p>
                    
                    <button onclick="manualSelectTarget()" disabled class="auth-required opacity-50 w-full bg-slate-800 hover:bg-slate-700 py-3 rounded-xl border border-slate-700 transition text-xs font-bold mb-6">
                        <i class="fas fa-search-location mr-2"></i>瀏覽雲端硬碟
                    </button>

                    <div id="target-status-content" class="space-y-4">
                        <p class="text-[10px] text-slate-500 italic text-center">請先選取目標位置</p>
                    </div>
                </section>
            </div>

            <!-- 右側：存檔區 -->
            <div class="space-y-6">
                <section id="save-section" class="hidden glass-card p-6 rounded-3xl border-emerald-500/20">
                    <h2 class="text-sm font-bold mb-4 flex items-center gap-2 text-emerald-400">
                        <i class="fas fa-file-export"></i> 3. 匯入內容
                    </h2>
                    <textarea id="ai-output-content" rows="12" class="w-full bg-slate-900/50 border border-slate-700 rounded-2xl p-4 text-[11px] focus:ring-1 focus:ring-emerald-500 outline-none mb-4 custom-scrollbar" placeholder="在此貼上 AI 產出的 Markdown 詳細內容..."></textarea>
                    <button id="save-btn" onclick="saveToGoogleDoc()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-bold transition-all text-sm shadow-lg shadow-emerald-900/20">
                        確認存檔 (追加至文件)
                    </button>
                    <p class="mt-4 text-[9px] text-slate-500 text-center italic">內容將被追加到所選 Google 文件的最末端</p>
                </section>
                
                <div id="save-placeholder" class="glass-card p-6 rounded-3xl flex flex-col items-center justify-center text-center opacity-40 py-12">
                    <i class="fas fa-lock text-3xl mb-4 text-slate-600"></i>
                    <p class="text-xs text-slate-500">請先完成步驟 2<br>選取一個「目標文件」以開啟存檔功能</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-8 text-center text-slate-600 text-[10px] uppercase tracking-tighter">
        穩定運行中 • 支援多選與即時刪除 • 已獲取 Drive.File 操作權限
    </footer>

    <script>
        // 切換存檔區域顯示邏輯
        const observer = new MutationObserver(() => {
            const saveSection = document.getElementById('save-section');
            const placeholder = document.getElementById('save-placeholder');
            if (targetDocId) {
                saveSection.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                saveSection.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        });
        observer.observe(document.getElementById('target-status-content'), { childList: true });
    </script>
</body>
</html>